{% extends 'base.html' %}
{% block title %}{{ (product.brand_name or product.brand or '') }} {{ product.model_name or product.name }} - eGadget Rent{% endblock %}
{% block content %}
<div class="row g-4">
  <div class="col-md-5">
    <img src="{{ product.image_url or url_for('static', filename='images/placeholder.png') }}" class="img-fluid border rounded" alt="{{ (product.brand_name or product.brand or '') }} {{ product.model_name or product.name }}" style="max-height:520px; width:100%; object-fit:contain">
  </div>
  <div class="col-md-7">
    <h3>{{ (product.brand_name or product.brand or '') }} {{ product.model_name or product.name }}</h3>
    <div class="text-muted mb-2">Brand: {{ product.brand_name or product.brand or 'Unknown' }} • Category: {{ product.category }}{% if product.subcategory %} • {{ product.subcategory }}{% endif %}{% if product.condition %} • {{ product.condition }}{% endif %}</div>
    <div class="h5">₹ {{ '%.2f'|format(product.rent_per_day or 0) }}/day
      {% if product.avg_rating %}
        <span class="ms-2 small text-warning">
          {% for i in range(1,6) %}
            {% if i <= product.avg_rating|round(0, 'floor') %}<i class="bi bi-star-fill"></i>{% else %}<i class="bi bi-star"></i>{% endif %}
          {% endfor %}
          <span class="text-muted">({{ product.reviews_count }})</span>
        </span>
      {% endif %}
    </div>
    <div class="mb-3">Availability: {% if product.available %}<span class="badge bg-success">Available</span>{% else %}<span class="badge bg-secondary">Unavailable</span>{% endif %}</div>

    <div class="border rounded p-3 mb-3">
      <div class="row g-3 align-items-center">
        <div class="col-sm-6">
          <label class="form-label">Choose Days</label>
          <div class="input-group">
            <button class="btn btn-outline-secondary" id="daysMinus" type="button">−</button>
            <input id="daysInput" type="number" min="1" step="1" value="1" class="form-control text-center">
            <button class="btn btn-outline-secondary" id="daysPlus" type="button">+</button>
          </div>
        </div>
        <div class="col-sm-6">
          <label class="form-label">Choose Quantity</label>
          <div class="input-group">
            <button class="btn btn-outline-secondary" id="qtyMinus" type="button">−</button>
            <input id="qtyInput" type="number" min="1" step="1" value="1" class="form-control text-center">
            <button class="btn btn-outline-secondary" id="qtyPlus" type="button">+</button>
          </div>
        </div>
        <div class="col-sm-6">
          <label class="form-label">Select Delivery Date</label>
          <input id="deliveryDate" type="date" class="form-control">
        </div>
        <div class="col-sm-6">
          <label class="form-label">Location</label>
          <input id="locationInput" type="text" class="form-control" placeholder="City / Address" required>
          <div class="text-danger small mt-1" id="locationError" style="display:none">Location is required to place an order</div>
        </div>
      </div>
      <div class="mt-3 d-flex justify-content-between align-items-center">
        <div>
          <div class="small text-muted">Security Deposit (refundable)</div>
          <div class="fw-semibold">₹ <span id="depositValue">0.00</span></div>
        </div>
        <div>
          <div class="small text-muted">Total Price</div>
          <div class="h5 mb-0">₹ <span id="totalValue">0.00</span></div>
        </div>
      </div>
      <div class="mt-3 d-flex gap-2">
        <button class="btn btn-primary" id="rentNowBtn" {% if not product.available %}disabled{% endif %}>Rent Now</button>
        <button class="btn btn-outline-primary" id="addToCartBtn" {% if not product.available %}disabled{% endif %}><i class="bi bi-cart-plus"></i> Add to Cart</button>
        <a class="btn btn-outline-secondary" href="{{ url_for('catalog') }}?category={{ product.category }}{% if product.subcategory %}&sub={{ product.subcategory }}{% endif %}">Back to Catalog</a>
      </div>
    </div>

    {% if product.description %}
    <div class="mt-3">
      <h6>Description</h6>
      <p class="text-muted">{{ product.description }}</p>
    </div>
    {% endif %}

    <form id="wishlist-toggle" class="mt-3" method="post" action="{{ url_for('api_wishlist_toggle') }}">
      <input type="hidden" name="product_id" value="{{ product.id }}">
      <button type="submit" class="btn btn-outline-danger"><i class="bi bi-heart me-1"></i> Save to Wishlist</button>
    </form>
  </div>
</div>

<hr class="my-4">
<div class="row">
  <div class="col-md-7">
    <h5 class="mb-3">Customer Reviews</h5>
    {% if product.reviews %}
      {% for r in product.reviews|reverse %}
        <div class="border rounded p-3 mb-2 review-item" data-review-id="{{ r.review_id }}">
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <strong>{{ r.name or 'User' }}</strong>
              <span class="text-warning ms-2">
                {% for i in range(1,5+1) %}
                  {% if i <= (r.rating or 0) %}<i class="fa fa-star"></i>{% else %}<i class="fa-regular fa-star"></i>{% endif %}
                {% endfor %}
              </span>
            </div>
            {% if is_admin and r.review_id %}
            <button class="btn btn-sm btn-outline-danger delete-review-btn" data-product-id="{{ product.id }}" data-review-id="{{ r.review_id }}" title="Delete review">
              <i class="bi bi-trash"></i>
            </button>
            {% endif %}
          </div>
          {% if r.comment %}<div class="mt-2">{{ r.comment }}</div>{% endif %}
        </div>
      {% endfor %}
    {% else %}
      <div class="text-muted">No reviews yet.</div>
    {% endif %}
  </div>
  <div class="col-md-5">
    <h5 class="mb-3">Write a review</h5>
    <form method="post" action="{{ url_for('add_review', product_id=product.id) }}">
      <div class="mb-2">
        <label class="form-label">Rating</label>
        <select class="form-select" name="rating">
          {% for i in range(1,6) %}<option value="{{ i }}">{{ i }} ⭐</option>{% endfor %}
        </select>
      </div>
      <div class="mb-2">
        <label class="form-label">Comment (optional)</label>
        <textarea class="form-control" rows="3" name="comment"></textarea>
      </div>
      <button class="btn btn-primary">Submit Review</button>
    </form>
  </div>
</div>

{% if related_products %}
<hr class="my-4">
<h5>People also rented</h5>
  <div class="row g-3">
  {% for rec in related_products %}
  <div class="col-6 col-md-3">
    <div class="card h-100 card-hover">
      <img src="{{ rec.image_url or url_for('static', filename='images/placeholder.png') }}" class="card-img-top object-fit-contain p-3" style="height:140px" alt="{{ (rec.brand_name or rec.brand or '') }} {{ rec.model_name or rec.name }}">
      <div class="card-body">
        <div class="small text-muted">{{ rec.category }}</div>
        <div class="fw-semibold text-truncate">{{ (rec.brand_name or rec.brand or '') }} {{ rec.model_name or rec.name }}</div>
        <a class="btn btn-sm btn-outline-primary mt-2" href="{{ url_for('product_detail', product_id=rec.id) }}">View</a>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

{% if is_admin %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const deleteButtons = document.querySelectorAll('.delete-review-btn');
  deleteButtons.forEach(btn => {
    btn.addEventListener('click', async function() {
      if (!confirm('Are you sure you want to delete this review?')) return;
      
      const productId = this.dataset.productId;
      const reviewId = this.dataset.reviewId;
      const reviewItem = this.closest('.review-item');
      
      const formData = new FormData();
      formData.append('product_id', productId);
      formData.append('review_id', reviewId);
      
      try {
        const res = await fetch('{{ url_for("admin_review_delete") }}', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        if (data.ok) {
          reviewItem.remove();
          location.reload(); // Reload to update rating
        } else {
          alert('Failed to delete review');
        }
      } catch (error) {
        alert('An error occurred');
      }
    });
  });
});
</script>
{% endif %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const pricePerDay = Number("{{ product.rent_per_day or 0 }}");
  const daysInput = document.getElementById('daysInput');
  const qtyInput = document.getElementById('qtyInput');
  const daysMinus = document.getElementById('daysMinus');
  const daysPlus = document.getElementById('daysPlus');
  const qtyMinus = document.getElementById('qtyMinus');
  const qtyPlus = document.getElementById('qtyPlus');
  const totalEl = document.getElementById('totalValue');
  const depositEl = document.getElementById('depositValue');
  const deliveryDate = document.getElementById('deliveryDate');
  const locationInput = document.getElementById('locationInput');
  const locationError = document.getElementById('locationError');
  const rentBtn = document.getElementById('rentNowBtn');
  const productId = "{{ product.id }}";
  function clamp(val) { return Math.max(1, Math.floor(Number(val)||1)); }
  function validateInputs() {
    const d = clamp(daysInput.value);
    const q = clamp(qtyInput.value);
    const ddate = deliveryDate.value;
    const loc = locationInput.value.trim();
    const ok = d > 0 && q > 0 && !!ddate && loc.length > 0;
    rentBtn.disabled = !ok;
    locationError.style.display = loc.length > 0 ? 'none' : 'block';
    return ok;
  }
  function updateTotals() {
    const d = clamp(daysInput.value);
    const q = clamp(qtyInput.value);
    const total = pricePerDay * d * q;
    const deposit = Math.round(total * 0.30 * 100) / 100;
    totalEl.textContent = total.toFixed(2);
    depositEl.textContent = deposit.toFixed(2);
    validateInputs();
  }
  daysMinus.addEventListener('click', () => { daysInput.value = clamp(daysInput.value) - 1; updateTotals(); });
  daysPlus.addEventListener('click', () => { daysInput.value = clamp(daysInput.value) + 1; updateTotals(); });
  qtyMinus.addEventListener('click', () => { qtyInput.value = clamp(qtyInput.value) - 1; updateTotals(); });
  qtyPlus.addEventListener('click', () => { qtyInput.value = clamp(qtyInput.value) + 1; updateTotals(); });
  daysInput.addEventListener('input', updateTotals);
  qtyInput.addEventListener('input', updateTotals);
  deliveryDate.addEventListener('change', updateTotals);
  locationInput.addEventListener('input', updateTotals);
  updateTotals();
  
  // Add to Cart Logic
  const addToCartBtn = document.getElementById('addToCartBtn');
  if (addToCartBtn) {
    addToCartBtn.addEventListener('click', async () => {
      const days = clamp(daysInput.value);
      const qty = clamp(qtyInput.value);
      
      const fd = new FormData();
      fd.append('product_id', productId);
      fd.append('days', String(days));
      fd.append('quantity', String(qty));
      
      try {
          addToCartBtn.disabled = true;
          const originalContent = addToCartBtn.innerHTML;
          addToCartBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Adding...';
          
          const res = await fetch('{{ url_for("api_cart_add") }}', { method: 'POST', body: fd });
          const data = await res.json();
          
          if (data.ok) {
              const badge = document.querySelector('.bi-cart-fill + .badge');
              if (badge) {
                  badge.textContent = data.cart_count;
              } else if (data.cart_count > 0) {
                   // If badge doesn't exist yet (cart was empty), we might want to add it, but simpler to just reload or ignore if not critical. 
                   // Or find the cart link and append badge.
                   const cartLink = document.querySelector('a[href="{{ url_for("cart_page") }}"]');
                   if (cartLink) {
                       const newBadge = document.createElement('span');
                       newBadge.className = 'position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger';
                       newBadge.textContent = data.cart_count;
                       cartLink.appendChild(newBadge);
                   }
              }
              
              if (typeof showToast === 'function') {
                  showToast('Added to cart!', 'success');
              } else {
                  alert('Added to cart!');
              }
          } else {
              if (typeof showToast === 'function') {
                  showToast(data.message || 'Failed to add to cart', 'error');
              } else {
                  alert(data.message || 'Failed to add to cart');
              }
          }
          
          addToCartBtn.innerHTML = originalContent;
      } catch (e) {
          console.error(e);
          if (typeof showToast === 'function') {
              showToast('Network error', 'error');
          } else {
              alert('Network error');
          }
          addToCartBtn.innerHTML = '<i class="bi bi-cart-plus"></i> Add to Cart';
      } finally {
          addToCartBtn.disabled = false;
      }
    });
  }

  rentBtn.addEventListener('click', async () => {
    const days = clamp(daysInput.value);
    const qty = clamp(qtyInput.value);
    const ddate = deliveryDate.value;
    const loc = locationInput.value.trim();
    if (!validateInputs()) return;
    const total = pricePerDay * days * qty;
    const deposit = Math.round(total * 0.30 * 100) / 100;
    const fd = new FormData();
    fd.append('product_id', productId);
    fd.append('days', String(days));
    fd.append('quantity', String(qty));
    fd.append('delivery_date', ddate);
    fd.append('location', loc);
    fd.append('total', String(total.toFixed(2)));
    fd.append('deposit', String(deposit.toFixed(2)));
    try {
      const res = await fetch('{{ url_for("api_rental_start") }}', { method: 'POST', body: fd });
      const data = await res.json();
      if (data.ok && data.redirect_url) {
        window.location.href = data.redirect_url;
      } else {
        showToast(data.message || 'Unable to start rental', 'error');
      }
    } catch (e) {
      showToast('Network error', 'error');
    }
  });
});
</script>
{% endblock %}
